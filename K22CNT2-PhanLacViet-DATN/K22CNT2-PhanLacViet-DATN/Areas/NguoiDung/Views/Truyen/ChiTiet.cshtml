@model K22CNT2_PhanLacViet_DATN.Areas.NguoiDung.Models.TrangTruyenViewModel
@{
    Layout = "~/Areas/NguoiDung/Views/Shared/_Layout.cshtml";
}
<link href="~/NguoiDung/css/ChiTiet.css" rel="stylesheet" />

<div class="container">
    <div class="story-header">
        <div class="cover-image">
            @* DB không có AnhBia nên dùng ảnh mặc định *@
            <img src="https://via.placeholder.com/220x330?text=No+Cover" alt="@Model.ThongTinTruyen.TenTruyen">
        </div>
        <div class="story-info">
            <h1 class="story-title">@Model.ThongTinTruyen.TenTruyen</h1>
            <div class="meta-data"><span>Tác giả:</span> @(Model.ThongTinTruyen.TacGia ?? "Đang cập nhật")</div>
            <div class="meta-data"><span>Thể loại:</span> @(Model.ThongTinTruyen.TenTheLoai ?? "Khác")</div>
            <div class="meta-data"><span>Lượt xem:</span> @Model.ThongTinTruyen.TongLuotXem.ToString("N0")</div>
            <div class="meta-data"><span>Đánh giá:</span> <strong style="color:#f1c40f">@Model.DiemDanhGiaTrungBinh <i class="fa-solid fa-star"></i></strong></div>

            <div class="actions">
                <button id="btnFollow" class="btn-action @(Model.DaTheoDoi ? "active" : "")"
                        onclick="toggleFollow(@Model.ThongTinTruyen.MaTruyen)">
                    <i class="@(Model.DaTheoDoi ? "fa-solid" : "fa-regular") fa-heart"></i>
                    <span id="txtFollow">@(Model.DaTheoDoi ? "Đang theo dõi" : "Theo dõi")</span>
                </button>

                <button class="btn-action @(Model.DaDanhGia ? "rated" : "")" onclick="openRatingModal()">
                    <i class="fa-solid fa-star"></i> Đánh giá
                </button>
            </div>
            <div id="ratingModal" class="modal-overlay" style="display:none;">
                <div class="rating-box">
                    <h3>Đánh giá truyện: @Model.ThongTinTruyen.TenTruyen</h3>

                    <div class="stars">
                        <input type="radio" name="rating" id="star5" value="5"> <label for="star5">★</label>
                        <input type="radio" name="rating" id="star4" value="4"> <label for="star4">★</label>
                        <input type="radio" name="rating" id="star3" value="3"> <label for="star3">★</label>
                        <input type="radio" name="rating" id="star2" value="2"> <label for="star2">★</label>
                        <input type="radio" name="rating" id="star1" value="1"> <label for="star1">★</label>
                    </div>

                    <textarea id="reviewContent" placeholder="Nhập nội dung đánh giá..."></textarea>

                    <div class="btn-group">
                        <button class="btn-submit" onclick="submitReview(@Model.ThongTinTruyen.MaTruyen)">Gửi đánh giá</button>
                        <button class="btn-cancel" onclick="closeRatingModal()">Hủy</button>
                    </div>
                </div>
            </div>
            <div class="description">
                <h3>Mô tả</h3>
                <p>@Model.ThongTinTruyen.MoTa</p>
            </div>
        </div>
    </div>

    <div class="chapter-list">
        <h3>Danh sách chương (@Model.DanhSachChuong.Count)</h3>
        <div class="chapter-grid">
            @for (int i = 0; i < Model.DanhSachChuong.Count; i++)
            {
                var chuong = Model.DanhSachChuong[i];
                <a href="@Url.Action("ChiTietChuong", "Truyen", new { id = chuong.MaChuongTruyen })"
                   class="chapter-item @(i >= 10 ? "hidden-chapter" : "")"
                   data-thutu="@chuong.ThuTuChuong">
                    @chuong.TieuDe
                </a>
            }
        </div>
        @if (Model.DanhSachChuong.Count > 10)
        {
            <div style="text-align:center; margin-top:15px">
                <button id="btnLoadMore" class="btn-action">Xem thêm chương</button>
            </div>
        }
    </div>

    <div class="comment-section">
        <h3>Bình luận</h3>
        @foreach (var bl in Model.DanhSachBinhLuan)
        {
            <div class="comment">
                <div class="user-name">@bl.TaiKhoan <small>- @bl.NgayGui?.ToString("dd/MM/yyyy")</small></div>
                <p class="comment-content">@bl.NoiDung</p>
            </div>
            @foreach (var rep in bl.RepBinhLuans)
            {
                <div class="comment reply-comment">
                    <div class="user-name">@rep.TaiKhoan <small>- @rep.NgayGui?.ToString("dd/MM/yyyy")</small></div>
                    <p class="comment-content">@rep.NoiDung</p>
                </div>
            }
        }
    </div>
</div>

@section Scripts {
    <script>
        var maxReadOrder = @(Model.ThuTuChuongDaDoc ?? 0);
        var currentUser = '@Context.Session.GetString("USER_LOGIN")';
    </script>
    <script src="~/NguoiDung/js/ChiTiet.js"></script>
}